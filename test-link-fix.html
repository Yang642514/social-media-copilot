<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试链接字段修复</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .note-card {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            background: #fff;
        }
        .note-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .note-content {
            color: #666;
            margin-bottom: 12px;
        }
        .note-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #999;
        }
        .test-button {
            background: #ff2442;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #e01e3c;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>🔗 链接字段修复测试</h1>
    
    <div class="status info">
        <strong>修复内容：</strong>
        <ul>
            <li>将笔记链接字段类型从文本(1)改为超链接(15)</li>
            <li>将链接值从字符串改为包含text和link属性的对象</li>
            <li>添加了链接格式错误的详细提示</li>
        </ul>
    </div>

    <h2>📝 测试笔记样本</h2>
    
    <!-- 模拟小红书笔记1 -->
    <div class="note-card" data-note-id="test1">
        <div class="note-title">秋日穿搭分享｜温柔奶茶色系</div>
        <div class="note-content">今天分享一套超温柔的奶茶色系穿搭～米色毛衣配卡其色阔腿裤，简约又有质感✨</div>
        <div class="note-meta">
            <span class="note-author">@时尚博主小美</span>
            <span class="note-time">2小时前</span>
            <span class="note-likes">❤️ 1.2k</span>
            <span class="note-type">图文</span>
        </div>
    </div>

    <!-- 模拟小红书笔记2 -->
    <div class="note-card" data-note-id="test2">
        <div class="note-title">超简单的蜂蜜柠檬茶做法</div>
        <div class="note-content">天气转凉了，来一杯暖暖的蜂蜜柠檬茶～只需要3个步骤就能做出美味的饮品🍋</div>
        <div class="note-meta">
            <span class="note-author">@美食达人小厨</span>
            <span class="note-time">5小时前</span>
            <span class="note-likes">❤️ 856</span>
            <span class="note-type">图文</span>
        </div>
    </div>

    <h2>🧪 测试操作</h2>
    <button class="test-button" onclick="testDataExtraction()">提取笔记数据</button>
    <button class="test-button" onclick="testFeishuSync()">测试飞书同步</button>
    <button class="test-button" onclick="clearResults()">清除结果</button>

    <div id="test-results"></div>

    <script>
        let extractedData = null;

        function showStatus(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            resultsDiv.appendChild(statusDiv);
        }

        function testDataExtraction() {
            showStatus('🔍 开始提取笔记数据...', 'info');
            
            // 模拟数据提取
            const noteCards = document.querySelectorAll('.note-card');
            const notes = [];
            
            noteCards.forEach((card, index) => {
                const title = card.querySelector('.note-title').textContent;
                const content = card.querySelector('.note-content').textContent;
                const author = card.querySelector('.note-author').textContent.replace('@', '');
                const time = card.querySelector('.note-time').textContent;
                const likes = card.querySelector('.note-likes').textContent.replace('❤️ ', '');
                const type = card.querySelector('.note-type').textContent;
                
                const noteData = {
                    title: title,
                    content: content,
                    author: author,
                    publishTime: time,
                    likes: likes,
                    noteType: type,
                    url: `https://www.xiaohongshu.com/explore/test${index + 1}?xsec_token=test&xsec_source=pc_feed`
                };
                
                notes.push(noteData);
            });
            
            extractedData = notes;
            
            showStatus(`✅ 成功提取 ${notes.length} 条笔记数据`, 'success');
            showStatus(`📋 数据预览：<pre>${JSON.stringify(notes[0], null, 2)}</pre>`, 'info');
        }

        function testFeishuSync() {
            if (!extractedData) {
                showStatus('❌ 请先提取笔记数据', 'error');
                return;
            }

            showStatus('🚀 开始测试飞书同步...', 'info');
            
            // 模拟链接字段格式
            const linkFieldData = {
                old_format: extractedData[0].url, // 旧格式：字符串
                new_format: {
                    text: extractedData[0].title,
                    link: extractedData[0].url
                }
            };
            
            showStatus(`🔗 链接字段格式对比：
                <br><strong>修复前（字符串格式）：</strong>
                <pre>"${linkFieldData.old_format}"</pre>
                <br><strong>修复后（对象格式）：</strong>
                <pre>${JSON.stringify(linkFieldData.new_format, null, 2)}</pre>`, 'info');
            
            // 模拟发送到后台脚本
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({
                    action: 'syncToFeishu',
                    data: extractedData[0]
                }, (response) => {
                    if (response && response.success) {
                        showStatus('✅ 飞书同步成功！链接字段格式修复生效', 'success');
                    } else {
                        showStatus(`❌ 飞书同步失败：${response?.error || '未知错误'}`, 'error');
                    }
                });
            } else {
                showStatus('⚠️ 浏览器扩展环境未检测到，无法测试实际同步功能', 'error');
                showStatus('💡 请在小红书页面中使用扩展功能进行实际测试', 'info');
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            extractedData = null;
        }

        // 页面加载完成后显示说明
        window.onload = function() {
            showStatus('📖 测试说明：此页面用于验证链接字段格式修复。点击"提取笔记数据"开始测试，然后点击"测试飞书同步"查看修复效果。', 'info');
        };
    </script>
</body>
</html>